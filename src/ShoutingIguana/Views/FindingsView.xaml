<UserControl x:Class="ShoutingIguana.Views.FindingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:sdk="clr-namespace:ShoutingIguana.PluginSdk;assembly=ShoutingIguana.PluginSdk"
             Background="{StaticResource BackgroundBrush}">
    
    <UserControl.Resources>
        <!-- Severity Badge Selector -->
        <Style x:Key="SeverityBadgeStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding Severity}" Value="{x:Static sdk:Severity.Error}">
                    <Setter Property="Background" Value="#FFEBEE"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Severity}" Value="{x:Static sdk:Severity.Warning}">
                    <Setter Property="Background" Value="#FFF8E1"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Severity}" Value="{x:Static sdk:Severity.Info}">
                    <Setter Property="Background" Value="#E3F2FD"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        
        <Style x:Key="SeverityTextStyle" TargetType="TextBlock">
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding Severity}" Value="{x:Static sdk:Severity.Error}">
                    <Setter Property="Foreground" Value="{StaticResource ErrorBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Severity}" Value="{x:Static sdk:Severity.Warning}">
                    <Setter Property="Foreground" Value="{StaticResource WarningBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Severity}" Value="{x:Static sdk:Severity.Info}">
                    <Setter Property="Foreground" Value="{StaticResource InfoBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>
    
    <Grid Margin="{StaticResource SpacingL}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="2*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="1*" MinHeight="200"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0" Margin="{StaticResource SpacingL}">
            <TextBlock Text="Findings"
                       Style="{StaticResource DisplayTextStyle}"
                       VerticalAlignment="Center"
                       AutomationProperties.HeadingLevel="Level1"
                       AutomationProperties.AutomationId="FindingsPageHeading"/>
            
            <StackPanel Style="{StaticResource ToolbarPanel}" AutomationProperties.Name="Findings Toolbar">
                <Button Command="{Binding RefreshCommand}"
                        Style="{StaticResource SecondaryButton}"
                        Margin="0,0,8,0"
                        AutomationProperties.Name="Refresh Findings"
                        ToolTip="Refresh findings from database">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{StaticResource Icon.Refresh}"
                                   Style="{StaticResource Icon}"
                                   Width="16" 
                                   Height="16"
                                   FontSize="16"
                                   Margin="0,0,6,0"/>
                        <TextBlock Text="Refresh" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
                <Button Command="{Binding ExportToCsvCommand}"
                        Style="{StaticResource SecondaryButton}"
                        Margin="0,0,8,0"
                        AutomationProperties.Name="Export to CSV"
                        ToolTip="Export findings to CSV file">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{StaticResource Icon.FileCSV}"
                                   Style="{StaticResource Icon}"
                                   Width="16" 
                                   Height="16"
                                   FontSize="16"
                                   Margin="0,0,6,0"/>
                        <TextBlock Text="CSV" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
                <Button Command="{Binding ExportToExcelCommand}"
                        Style="{StaticResource PrimaryButton}"
                        AutomationProperties.Name="Export to Excel"
                        ToolTip="Export findings to Excel workbook">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{StaticResource Icon.FileExcel}"
                                   Style="{StaticResource Icon}"
                                   Width="16" 
                                   Height="16"
                                   FontSize="16"
                                   Margin="0,0,6,0"/>
                        <TextBlock Text="Excel" 
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>

        <!-- Tabbed Findings View -->
        <Border Grid.Row="1" 
                Style="{StaticResource Card}"
                Padding="4">
            <TabControl ItemsSource="{Binding Tabs}" 
                        SelectedItem="{Binding SelectedTab}"
                        Style="{StaticResource StandardTabControl}"
                        Background="{StaticResource SurfaceBrush}">
                <TabControl.ItemContainerStyle>
                    <Style TargetType="TabItem" BasedOn="{StaticResource {x:Type TabItem}}">
                        <Setter Property="Height" Value="48"/>
                    </Style>
                </TabControl.ItemContainerStyle>
                <TabControl.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal" Margin="12,0">
                            <TextBlock Text="{Binding TabHeader}" 
                                       VerticalAlignment="Center"
                                       Margin="0,0,8,0"
                                       FontWeight="Medium"/>
                            <Border Background="{StaticResource ErrorBrush}" 
                                    CornerRadius="10" 
                                    Padding="6,2"
                                    VerticalAlignment="Center"
                                    Visibility="{Binding ErrorCount, Converter={StaticResource Int32ToVisibilityConverter}}">
                                <TextBlock Text="{Binding ErrorCount}" 
                                           Foreground="White" 
                                           FontSize="10"
                                           FontWeight="Bold"/>
                            </Border>
                        </StackPanel>
                    </DataTemplate>
                </TabControl.ItemTemplate>
                <TabControl.ContentTemplate>
                    <DataTemplate>
                        <Grid Margin="16">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- Filters -->
                            <Grid Grid.Row="0" Margin="0,0,0,20">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="16"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="16"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Severity Filter -->
                                <StackPanel Grid.Column="0" Margin="0">
                                    <TextBlock Text="Severity" 
                                               Style="{StaticResource FormFieldLabel}"
                                               Margin="0,0,0,6"/>
                                    <ComboBox MinWidth="140"
                                              SelectedValue="{Binding SelectedSeverity, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              SelectedValuePath="Tag"
                                              Style="{StaticResource ModernComboBox}"
                                              AutomationProperties.Name="Filter by Severity"
                                              ToolTip="Filter findings by severity level">
                                        <ComboBoxItem Content="All" Tag="{x:Null}"/>
                                        <ComboBoxItem Content="Error" Tag="{x:Static sdk:Severity.Error}"/>
                                        <ComboBoxItem Content="Warning" Tag="{x:Static sdk:Severity.Warning}"/>
                                        <ComboBoxItem Content="Info" Tag="{x:Static sdk:Severity.Info}"/>
                                    </ComboBox>
                                </StackPanel>
                                
                                <!-- Search Box -->
                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="Search" 
                                               Style="{StaticResource FormFieldLabel}"
                                               Margin="0,0,0,6"/>
                                    <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                             MinWidth="250"
                                             Style="{StaticResource ModernTextBox}"
                                             AutomationProperties.Name="Search Findings"
                                             ToolTip="Search findings by message, code, or URL"/>
                                </StackPanel>
                                         
                                <!-- Total Count -->
                                <Border Grid.Column="4"
                                        Background="{StaticResource SurfaceAltBrush}"
                                        CornerRadius="6"
                                        Padding="16,10"
                                        Height="40"
                                        VerticalAlignment="Bottom">
                                    <TextBlock VerticalAlignment="Center"
                                               Foreground="{StaticResource TextSecondaryBrush}"
                                               FontWeight="SemiBold"
                                               FontSize="13">
                                        <Run Text="Total:"/>
                                        <Run Text="{Binding TotalCount, Mode=OneWay}" 
                                             Foreground="{StaticResource TextPrimaryBrush}"
                                             FontSize="14"
                                             FontWeight="Bold"/>
                                    </TextBlock>
                                </Border>
                            </Grid>

                            <!-- Findings DataGrid -->
                            <DataGrid Grid.Row="1"
                                      ItemsSource="{Binding FilteredFindings}"
                                      SelectedItem="{Binding SelectedFinding, Mode=TwoWay}"
                                      Style="{StaticResource ModernDataGrid}"
                                      AutomationProperties.Name="Findings List"
                                      AutomationProperties.HelpText="List of findings discovered during the crawl. Select a row to view details below.">
                                <DataGrid.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="Copy URL" 
                                                  Command="{Binding CopyUrlCommand}"
                                                  AutomationProperties.Name="Copy URL to Clipboard">
                                            <MenuItem.Icon>
                                                <TextBlock Text="{StaticResource Icon.Copy}" Style="{StaticResource Icon}"/>
                                            </MenuItem.Icon>
                                        </MenuItem>
                                        <MenuItem Header="Copy Message" 
                                                  Command="{Binding CopyMessageCommand}"
                                                  AutomationProperties.Name="Copy Message to Clipboard">
                                            <MenuItem.Icon>
                                                <TextBlock Text="{StaticResource Icon.Copy}" Style="{StaticResource Icon}"/>
                                            </MenuItem.Icon>
                                        </MenuItem>
                                        <Separator/>
                                        <MenuItem Header="Open in Browser" 
                                                  Command="{Binding OpenInBrowserCommand}"
                                                  AutomationProperties.Name="Open URL in Default Browser">
                                            <MenuItem.Icon>
                                                <TextBlock Text="{StaticResource Icon.OpenInNew}" Style="{StaticResource Icon}"/>
                                            </MenuItem.Icon>
                                        </MenuItem>
                                    </ContextMenu>
                                </DataGrid.ContextMenu>
                                <DataGrid.Columns>
                                    <DataGridTemplateColumn Header="Severity" Width="110">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Border Style="{StaticResource SeverityBadgeStyle}">
                                                    <TextBlock Text="{Binding Severity}" 
                                                               Style="{StaticResource SeverityTextStyle}"/>
                                                </Border>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTextColumn Header="Code" 
                                                        Binding="{Binding Code}" 
                                                        Width="150"
                                                        FontFamily="Consolas"
                                                        FontSize="13"/>
                                    <DataGridTextColumn Header="Message" 
                                                        Binding="{Binding Message}" 
                                                        Width="*"
                                                        MinWidth="200"/>
                                    <DataGridTextColumn Header="URL" 
                                                        Binding="{Binding Url.Address}" 
                                                        Width="350"
                                                        FontFamily="Consolas"
                                                        FontSize="12"/>
                                    <DataGridTextColumn Header="Date" 
                                                        Binding="{Binding CreatedUtc, StringFormat='yyyy-MM-dd HH:mm:ss'}" 
                                                        Width="160"
                                                        FontFamily="Consolas"
                                                        FontSize="12"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </DataTemplate>
                </TabControl.ContentTemplate>
            </TabControl>
        </Border>

        <!-- Splitter -->
        <GridSplitter Grid.Row="2" 
                      Height="8" 
                      HorizontalAlignment="Stretch" 
                      Background="Transparent"
                      Cursor="SizeNS"
                      Margin="0,8"/>

        <!-- Details Panel -->
        <Border Grid.Row="3" 
                Style="{StaticResource Card}"
                Padding="20">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <Grid Grid.Row="0" Margin="{StaticResource SpacingS}">
                    <TextBlock Text="Finding Details" 
                               Style="{StaticResource TitleTextStyle}"
                               VerticalAlignment="Center"
                               AutomationProperties.HeadingLevel="Level2"
                               AutomationProperties.AutomationId="FindingDetailsHeading"/>
                    
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <TextBlock Text="JSON"
                                   Style="{StaticResource CaptionTextStyle}"
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0"/>
                        <TextBlock Text="{StaticResource Icon.CodeJson}"
                                   Style="{StaticResource Icon}"
                                   Width="20"
                                   Height="20"
                                   FontSize="20"
                                   Foreground="{StaticResource TextTertiaryBrush}"/>
                    </StackPanel>
                </Grid>
                           
                <Border Grid.Row="1"
                        Background="{StaticResource SurfaceAltBrush}"
                        CornerRadius="6"
                        BorderThickness="1"
                        BorderBrush="{StaticResource BorderLightBrush}">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" 
                                  HorizontalScrollBarVisibility="Auto"
                                  Padding="12">
                        <TextBox Text="{Binding DetailsJson, Mode=OneWay}"
                                 IsReadOnly="True"
                                 TextWrapping="Wrap"
                                 FontFamily="Consolas"
                                 FontSize="12"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 Foreground="{StaticResource TextPrimaryBrush}"
                                 AutomationProperties.Name="Finding Details JSON"
                                 AutomationProperties.HelpText="JSON representation of the selected finding. Read-only."/>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>
