<UserControl x:Class="ShoutingIguana.Views.LinkGraphView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="{StaticResource BackgroundBrush}">
    
    <Grid Margin="{StaticResource SpacingL}" KeyboardNavigation.TabNavigation="Local">
        <Grid.RenderTransform>
            <TranslateTransform/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)"
                                         From="20" To="0" Duration="0:0:0.4"
                                         DecelerationRatio="0.7"/>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                         From="0" To="1" Duration="0:0:0.4"
                                         DecelerationRatio="0.7"/>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Toolbar -->
            <RowDefinition Height="*"/>    <!-- Content -->
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" 
                Background="{StaticResource SurfaceBrush}"
                CornerRadius="8"
                Padding="24"
                Margin="0,0,0,24"
                SnapsToDevicePixels="True">
            <Border.Effect>
                <DropShadowEffect Color="#000000" BlurRadius="8" ShadowDepth="2" Opacity="0.06"/>
            </Border.Effect>
            <Grid>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <Border Background="{StaticResource PrimaryBrush}"
                            Width="44" Height="44"
                            CornerRadius="8"
                            Margin="0,0,16,0">
                        <TextBlock Text="{StaticResource Icon.Link}"
                                   Style="{StaticResource Icon}"
                                   FontSize="22"
                                   Foreground="White"/>
                    </Border>
                    <StackPanel VerticalAlignment="Center">
                        <TextBlock Text="Link Graph"
                                   Style="{StaticResource DisplayTextStyle}"
                                   FontSize="24"
                                   Margin="0"
                                   AutomationProperties.HeadingLevel="Level1"
                                   AutomationProperties.LiveSetting="Off"
                                   AutomationProperties.AutomationId="LinkGraphPageHeading"/>
                        <TextBlock Style="{StaticResource BodyTextStyle}"
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   Margin="0,4,0,0">
                            <Run Text="Showing"/>
                            <Run Text="{Binding FilteredLinkCount, Mode=OneWay}"/>
                            <Run Text="of"/>
                            <Run Text="{Binding TotalLinkCount, Mode=OneWay}"/>
                            <Run Text="links"/>
                        </TextBlock>
                    </StackPanel>
                </StackPanel>
                
                <StackPanel Style="{StaticResource ToolbarPanel}" 
                            AutomationProperties.Name="Link Graph Toolbar"
                            KeyboardNavigation.TabNavigation="Local">
                    <Button Command="{Binding RefreshCommand}"
                            Style="{StaticResource SecondaryButton}"
                            Margin="0,0,6,0"
                            TabIndex="0"
                            AutomationProperties.Name="Refresh Link Graph"
                            AutomationProperties.HelpText="Reloads the link graph data from the database to show latest results"
                            ToolTip="Refresh link graph (F5)">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{StaticResource Icon.Refresh}"
                                       Style="{StaticResource Icon}"
                                       FontSize="16"
                                       Margin="0,0,6,0"/>
                            <TextBlock Text="Refresh" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding ExportToCsvCommand}"
                            Style="{StaticResource SecondaryButton}"
                            TabIndex="1"
                            AutomationProperties.Name="Export to CSV"
                            AutomationProperties.HelpText="Exports the link graph data to a CSV file for further analysis"
                            ToolTip="Export link graph to CSV file">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{StaticResource Icon.Export}"
                                       Style="{StaticResource Icon}"
                                       FontSize="16"
                                       Margin="0,0,6,0"/>
                            <TextBlock Text="Export CSV" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Search Toolbar -->
        <Border Grid.Row="1" 
                Style="{StaticResource Card}"
                Margin="0,0,0,16"
                Padding="16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <!-- Search Box -->
                <TextBox Grid.Column="0"
                         Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                         Style="{StaticResource ModernTextBox}"
                         TabIndex="2"
                         AutomationProperties.Name="Search Links"
                         AutomationProperties.HelpText="Search links by URL or anchor text"
                         ToolTip="Search by URL or anchor text">
                    <TextBox.Tag>Search by URL or anchor text...</TextBox.Tag>
                </TextBox>
            </Grid>
        </Border>
        
        <!-- Content -->
        <Border Grid.Row="2" Style="{StaticResource Card}">
            <Grid>
                <!-- Skeleton Loader (shown while loading) -->
                <ItemsControl Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                              Margin="12">
                    <ItemsControl.Items>
                        <!-- 8 skeleton rows -->
                        <Border Style="{StaticResource SkeletonRow}">
                            <Grid Margin="12,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="100"/>
                                </Grid.ColumnDefinitions>
                                <Rectangle Grid.Column="0" Style="{StaticResource SkeletonCell}" Width="280"/>
                                <Rectangle Grid.Column="1" Style="{StaticResource SkeletonCell}" Width="260"/>
                                <Rectangle Grid.Column="2" Style="{StaticResource SkeletonCell}" Width="150"/>
                                <Rectangle Grid.Column="3" Style="{StaticResource SkeletonCell}" Width="80"/>
                            </Grid>
                        </Border>
                        <Border Style="{StaticResource SkeletonRow}">
                            <Grid Margin="12,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="100"/>
                                </Grid.ColumnDefinitions>
                                <Rectangle Grid.Column="0" Style="{StaticResource SkeletonCell}" Width="260"/>
                                <Rectangle Grid.Column="1" Style="{StaticResource SkeletonCell}" Width="290"/>
                                <Rectangle Grid.Column="2" Style="{StaticResource SkeletonCell}" Width="130"/>
                                <Rectangle Grid.Column="3" Style="{StaticResource SkeletonCell}" Width="80"/>
                            </Grid>
                        </Border>
                        <Border Style="{StaticResource SkeletonRow}">
                            <Grid Margin="12,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="100"/>
                                </Grid.ColumnDefinitions>
                                <Rectangle Grid.Column="0" Style="{StaticResource SkeletonCell}" Width="300"/>
                                <Rectangle Grid.Column="1" Style="{StaticResource SkeletonCell}" Width="250"/>
                                <Rectangle Grid.Column="2" Style="{StaticResource SkeletonCell}" Width="140"/>
                                <Rectangle Grid.Column="3" Style="{StaticResource SkeletonCell}" Width="80"/>
                            </Grid>
                        </Border>
                        <Border Style="{StaticResource SkeletonRow}">
                            <Grid Margin="12,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="100"/>
                                </Grid.ColumnDefinitions>
                                <Rectangle Grid.Column="0" Style="{StaticResource SkeletonCell}" Width="270"/>
                                <Rectangle Grid.Column="1" Style="{StaticResource SkeletonCell}" Width="280"/>
                                <Rectangle Grid.Column="2" Style="{StaticResource SkeletonCell}" Width="160"/>
                                <Rectangle Grid.Column="3" Style="{StaticResource SkeletonCell}" Width="80"/>
                            </Grid>
                        </Border>
                        <Border Style="{StaticResource SkeletonRow}">
                            <Grid Margin="12,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="100"/>
                                </Grid.ColumnDefinitions>
                                <Rectangle Grid.Column="0" Style="{StaticResource SkeletonCell}" Width="290"/>
                                <Rectangle Grid.Column="1" Style="{StaticResource SkeletonCell}" Width="270"/>
                                <Rectangle Grid.Column="2" Style="{StaticResource SkeletonCell}" Width="145"/>
                                <Rectangle Grid.Column="3" Style="{StaticResource SkeletonCell}" Width="80"/>
                            </Grid>
                        </Border>
                        <Border Style="{StaticResource SkeletonRow}">
                            <Grid Margin="12,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="100"/>
                                </Grid.ColumnDefinitions>
                                <Rectangle Grid.Column="0" Style="{StaticResource SkeletonCell}" Width="265"/>
                                <Rectangle Grid.Column="1" Style="{StaticResource SkeletonCell}" Width="295"/>
                                <Rectangle Grid.Column="2" Style="{StaticResource SkeletonCell}" Width="155"/>
                                <Rectangle Grid.Column="3" Style="{StaticResource SkeletonCell}" Width="80"/>
                            </Grid>
                        </Border>
                        <Border Style="{StaticResource SkeletonRow}">
                            <Grid Margin="12,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="100"/>
                                </Grid.ColumnDefinitions>
                                <Rectangle Grid.Column="0" Style="{StaticResource SkeletonCell}" Width="275"/>
                                <Rectangle Grid.Column="1" Style="{StaticResource SkeletonCell}" Width="265"/>
                                <Rectangle Grid.Column="2" Style="{StaticResource SkeletonCell}" Width="135"/>
                                <Rectangle Grid.Column="3" Style="{StaticResource SkeletonCell}" Width="80"/>
                            </Grid>
                        </Border>
                        <Border Style="{StaticResource SkeletonRow}">
                            <Grid Margin="12,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="100"/>
                                </Grid.ColumnDefinitions>
                                <Rectangle Grid.Column="0" Style="{StaticResource SkeletonCell}" Width="285"/>
                                <Rectangle Grid.Column="1" Style="{StaticResource SkeletonCell}" Width="275"/>
                                <Rectangle Grid.Column="2" Style="{StaticResource SkeletonCell}" Width="150"/>
                                <Rectangle Grid.Column="3" Style="{StaticResource SkeletonCell}" Width="80"/>
                            </Grid>
                        </Border>
                    </ItemsControl.Items>
                </ItemsControl>
                
                <!-- Empty State -->
                <StackPanel Style="{StaticResource EmptyStateContainer}"
                            Visibility="{Binding TotalLinkCount, Converter={StaticResource InverseInt32ToVisibilityConverter}}">
                    <TextBlock Text="{StaticResource Icon.Link}"
                               Style="{StaticResource EmptyStateIcon}"/>
                    <TextBlock Text="No Links Found"
                               Style="{StaticResource EmptyStateTitle}"/>
                    <TextBlock Text="Start a crawl to discover internal and external links."
                               Style="{StaticResource EmptyStateMessage}"/>
                </StackPanel>
                
                <!-- Data Grid -->
                <DataGrid ItemsSource="{Binding FilteredLinks}"
                          SelectedItem="{Binding SelectedLink}"
                          Style="{StaticResource ModernDataGrid}"
                          Visibility="{Binding TotalLinkCount, Converter={StaticResource Int32ToVisibilityConverter}}"
                          TabIndex="3"
                          AutomationProperties.Name="Link Graph"
                          AutomationProperties.HelpText="List of links discovered during crawl. Select a row to view details."
                          AutomationProperties.LiveSetting="Polite">
                    <DataGrid.ContextMenu>
                        <ContextMenu AutomationProperties.Name="Link Graph Context Menu">
                            <MenuItem Header="Copy From URL" 
                                      Command="{Binding CopyFromUrlCommand}"
                                      AutomationProperties.Name="Copy From URL to Clipboard">
                                <MenuItem.Icon>
                                    <TextBlock Text="{StaticResource Icon.Copy}" Style="{StaticResource Icon}"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="Copy To URL" 
                                      Command="{Binding CopyToUrlCommand}"
                                      AutomationProperties.Name="Copy To URL to Clipboard">
                                <MenuItem.Icon>
                                    <TextBlock Text="{StaticResource Icon.Copy}" Style="{StaticResource Icon}"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="Copy Anchor Text" 
                                      Command="{Binding CopyAnchorTextCommand}"
                                      AutomationProperties.Name="Copy Anchor Text to Clipboard">
                                <MenuItem.Icon>
                                    <TextBlock Text="{StaticResource Icon.Copy}" Style="{StaticResource Icon}"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator/>
                            <MenuItem Header="Open From URL in Browser" 
                                      Command="{Binding OpenFromUrlCommand}"
                                      AutomationProperties.Name="Open From URL in Default Browser">
                                <MenuItem.Icon>
                                    <TextBlock Text="{StaticResource Icon.OpenInNew}" Style="{StaticResource Icon}"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="Open To URL in Browser" 
                                      Command="{Binding OpenToUrlCommand}"
                                      AutomationProperties.Name="Open To URL in Default Browser">
                                <MenuItem.Icon>
                                    <TextBlock Text="{StaticResource Icon.OpenInNew}" Style="{StaticResource Icon}"/>
                                </MenuItem.Icon>
                            </MenuItem>
                        </ContextMenu>
                    </DataGrid.ContextMenu>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="From URL" 
                                            Binding="{Binding FromUrl}" 
                                            Width="2*"/>
                        <DataGridTextColumn Header="To URL" 
                                            Binding="{Binding ToUrl}" 
                                            Width="2*"/>
                        <DataGridTextColumn Header="Anchor Text" 
                                            Binding="{Binding AnchorText}" 
                                            Width="*"/>
                        <DataGridTextColumn Header="Type" 
                                            Binding="{Binding LinkType}" 
                                            Width="100"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>
    </Grid>
    
</UserControl>

