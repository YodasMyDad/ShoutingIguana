<Window x:Class="ShoutingIguana.Views.CustomExtractionDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Custom Extraction Rules"
        Height="600"
        Width="960"
        MinHeight="500"
        MinWidth="820"
        WindowStartupLocation="CenterOwner"
        Background="{StaticResource BackgroundBrush}"
        Foreground="{StaticResource TextPrimaryBrush}"
        ResizeMode="CanResize"
        ShowInTaskbar="False"
        UseLayoutRounding="True"
        TextOptions.TextFormattingMode="Display">
    
    <Grid Margin="0" KeyboardNavigation.TabNavigation="Cycle">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0"
                Background="{StaticResource SurfaceBrush}"
                BorderBrush="{StaticResource BorderLightBrush}"
                BorderThickness="0,0,0,1"
                Padding="24,20">
            <StackPanel Orientation="Horizontal">
                <Border Background="{StaticResource PrimaryBrush}"
                        Width="44" Height="44"
                        CornerRadius="8"
                        Margin="0,0,16,0">
                    <TextBlock Text="{StaticResource Icon.Code}"
                               Style="{StaticResource Icon}"
                               FontSize="22"
                               Foreground="White"/>
                </Border>
                <StackPanel VerticalAlignment="Center">
                    <TextBlock Text="Custom Extraction Rules"
                               Style="{StaticResource TitleTextStyle}"
                               Margin="0"
                               AutomationProperties.HeadingLevel="Level1"/>
                    <TextBlock Text="Define rules to extract specific data from crawled pages"
                               Style="{StaticResource BodyTextStyle}"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               Margin="0,4,0,0"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="1" Margin="{StaticResource SpacingL}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="32"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Rules List -->
            <Border Grid.Column="0" Style="{StaticResource Card}" VerticalAlignment="Stretch">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- List Header -->
                    <TextBlock Grid.Row="0"
                               Text="Extraction Rules"
                               Style="{StaticResource SubtitleTextStyle}"
                               Margin="0,0,0,12"/>

                    <!-- Rules DataGrid -->
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding Rules}"
                              SelectedItem="{Binding SelectedRule}"
                              Style="{StaticResource ModernDataGrid}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              SelectionMode="Single"
                              HeadersVisibility="Column"
                              GridLinesVisibility="None"
                              CanUserResizeRows="False"
                              Background="Transparent"
                              BorderThickness="0"
                              Margin="0,0,0,16"
                              TabIndex="0"
                              AutomationProperties.Name="Custom Extraction Rules List"
                              AutomationProperties.HelpText="List of custom extraction rules. Select a rule to edit it."
                              AutomationProperties.LiveSetting="Polite">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Name" 
                                                Binding="{Binding Name}" 
                                                Width="*"/>
                            <DataGridTextColumn Header="Type" 
                                                Binding="{Binding SelectorType, Converter={StaticResource SelectorTypeConverter}}" 
                                                Width="Auto"/>
                            <DataGridCheckBoxColumn Header="Enabled" 
                                                    Binding="{Binding IsEnabled}" 
                                                    Width="Auto"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- List Actions -->
                    <StackPanel Grid.Row="2"
                                Orientation="Horizontal"
                                HorizontalAlignment="Right"
                                Margin="0">
                        <Button Command="{Binding AddRuleCommand}"
                                Style="{StaticResource PrimaryButton}"
                                TabIndex="1"
                                AutomationProperties.Name="Add New Rule"
                                AutomationProperties.HelpText="Creates a new custom extraction rule"
                                ToolTip="Create a new extraction rule">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="+" 
                                           FontWeight="Bold" 
                                           Margin="0,0,6,0"/>
                                <TextBlock Text="Add"/>
                            </StackPanel>
                        </Button>
                        <Button Command="{Binding EditRuleCommand}"
                                Style="{StaticResource SecondaryButton}"
                                Margin="8,0,0,0"
                                TabIndex="2"
                                AutomationProperties.Name="Edit Selected Rule"
                                AutomationProperties.HelpText="Edits the currently selected extraction rule"
                                ToolTip="Edit the selected rule">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{StaticResource Icon.Edit}"
                                           Style="{StaticResource Icon}"
                                           Width="16"
                                           Height="16"
                                           Margin="0,0,6,0"/>
                                <TextBlock Text="Edit"/>
                            </StackPanel>
                        </Button>
                        <Button Command="{Binding DeleteRuleCommand}"
                                Style="{StaticResource DangerButton}"
                                Margin="8,0,0,0"
                                TabIndex="3"
                                AutomationProperties.Name="Delete Selected Rule"
                                AutomationProperties.HelpText="Deletes the currently selected extraction rule permanently"
                                ToolTip="Delete the selected rule">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{StaticResource Icon.Delete}"
                                           Style="{StaticResource Icon}"
                                           Width="16"
                                           Height="16"
                                           Margin="0,0,6,0"/>
                                <TextBlock Text="Delete"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Rule Editor -->
            <Border Grid.Column="2"
                    Style="{StaticResource Card}"
                    VerticalAlignment="Stretch"
                    Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Editor Header -->
                    <TextBlock Grid.Row="0"
                               Text="{Binding EditingRuleId, Converter={StaticResource RuleEditorTitleConverter}}"
                               Style="{StaticResource SubtitleTextStyle}"
                               Margin="0,0,0,16"/>

                    <!-- Editor Form -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Margin="0,0,0,24" Padding="0,0,8,0">
                        <StackPanel>
                            <!-- Name -->
                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="Rule Name" 
                                           Style="{StaticResource FormFieldLabel}"
                                           Margin="0,0,0,8"/>
                                <TextBox Text="{Binding EditingName, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource ModernTextBox}"
                                         TabIndex="4"
                                         AutomationProperties.Name="Rule Name"
                                         AutomationProperties.HelpText="Descriptive name for this extraction rule">
                                    <TextBox.Tag>e.g., Product Title</TextBox.Tag>
                                </TextBox>
                            </StackPanel>

                            <!-- Field Name -->
                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="Field Name (for export)" 
                                           Style="{StaticResource FormFieldLabel}"
                                           Margin="0,0,0,8"/>
                                <TextBox Text="{Binding EditingFieldName, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource ModernTextBox}"
                                         TabIndex="5"
                                         AutomationProperties.Name="Field Name for Export"
                                         AutomationProperties.HelpText="Column name when exporting extracted data">
                                    <TextBox.Tag>e.g., product_title</TextBox.Tag>
                                </TextBox>
                            </StackPanel>

                            <!-- Selector Type -->
                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="Selector Type" 
                                           Style="{StaticResource FormFieldLabel}"
                                           Margin="0,0,0,8"/>
                                <ComboBox SelectedIndex="{Binding EditingSelectorType}"
                                          Style="{StaticResource ModernComboBox}"
                                          TabIndex="6"
                                          AutomationProperties.Name="Selector Type"
                                          AutomationProperties.HelpText="Choose between CSS selector, XPath, or Regular Expression">
                                    <ComboBoxItem Content="CSS Selector"/>
                                    <ComboBoxItem Content="XPath"/>
                                    <ComboBoxItem Content="Regex"/>
                                </ComboBox>
                            </StackPanel>

                            <!-- Selector/Pattern -->
                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="Selector / Pattern" 
                                           Style="{StaticResource FormFieldLabel}"
                                           Margin="0,0,0,8"/>
                                <TextBox Text="{Binding EditingSelector, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource ModernTextBox}"
                                         AcceptsReturn="True"
                                         TextWrapping="Wrap"
                                         MinHeight="80"
                                         VerticalScrollBarVisibility="Auto"
                                         TabIndex="7"
                                         AutomationProperties.Name="Selector or Pattern"
                                         AutomationProperties.HelpText="CSS selector, XPath expression, or regular expression pattern">
                                    <TextBox.Tag>CSS: h1.title | XPath: //h1[@class='title'] | Regex: &lt;h1&gt;(.+?)&lt;/h1&gt;</TextBox.Tag>
                                    <TextBox.ToolTip>
                                        <ToolTip MaxWidth="400">
                                            <StackPanel>
                                                <TextBlock FontWeight="SemiBold" Margin="0,0,0,8">CSS Selector Examples (Full CSS3 Support):</TextBlock>
                                                <TextBlock TextWrapping="Wrap" Margin="0,0,0,4">• Basic: div, .class-name, #id-name</TextBlock>
                                                <TextBlock TextWrapping="Wrap" Margin="0,0,0,4">• Child combinator: div > p.highlight</TextBlock>
                                                <TextBlock TextWrapping="Wrap" Margin="0,0,0,4">• Attribute: a[href*="example"], input[type="text"]</TextBlock>
                                                <TextBlock TextWrapping="Wrap" Margin="0,0,0,4">• Pseudo-classes: a:nth-child(2), p:first-of-type</TextBlock>
                                                <TextBlock TextWrapping="Wrap" Margin="0,0,0,4">• Adjacent sibling: h1 + p</TextBlock>
                                                <TextBlock TextWrapping="Wrap" Margin="0,0,0,8">• Complex: div.container > article:not(.draft) h2</TextBlock>
                                                <TextBlock FontWeight="SemiBold" Margin="0,8,0,4">XPath Examples:</TextBlock>
                                                <TextBlock TextWrapping="Wrap" Margin="0,0,0,8">//div[@class='price']//span[@class='amount']</TextBlock>
                                                <TextBlock FontWeight="SemiBold" Margin="0,8,0,4">Regex Examples:</TextBlock>
                                                <TextBlock TextWrapping="Wrap">&lt;meta name="price" content="([^"]+)"/></TextBlock>
                                            </StackPanel>
                                        </ToolTip>
                                    </TextBox.ToolTip>
                                </TextBox>
                            </StackPanel>

                            <!-- Enabled -->
                            <CheckBox IsChecked="{Binding EditingIsEnabled}"
                                      Content="Enabled"
                                      FontSize="14"
                                      Margin="0,0,0,8"
                                      TabIndex="8"
                                      AutomationProperties.Name="Rule Enabled"
                                      AutomationProperties.HelpText="Enable or disable this extraction rule"/>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- Editor Actions -->
                    <StackPanel Grid.Row="2"
                                Orientation="Horizontal"
                                HorizontalAlignment="Right"
                                Margin="0">
                        <Button Content="Cancel"
                                Command="{Binding CancelEditCommand}"
                                Style="{StaticResource SecondaryButton}"
                                Margin="0,0,8,0"
                                TabIndex="9"
                                IsCancel="True"
                                AutomationProperties.Name="Cancel Edit"
                                AutomationProperties.HelpText="Cancels editing and discards changes"
                                ToolTip="Cancel changes (Esc)"/>
                        <Button Content="Save"
                                Command="{Binding SaveRuleCommand}"
                                Style="{StaticResource PrimaryButton}"
                                TabIndex="10"
                                IsDefault="True"
                                AutomationProperties.Name="Save Rule"
                                AutomationProperties.HelpText="Saves the extraction rule"
                                ToolTip="Save extraction rule (Enter)"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Placeholder when not editing -->
            <Border Grid.Column="2"
                    Style="{StaticResource Card}"
                    VerticalAlignment="Center"
                    Visibility="{Binding IsEditing, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <TextBlock Text="Select a rule to edit or click Add to create a new rule"
                               Style="{StaticResource BodyTextStyle}"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               TextAlignment="Center"
                               TextWrapping="Wrap"/>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Dialog Actions -->
        <Border Grid.Row="2"
                Background="{StaticResource SurfaceBrush}"
                BorderBrush="{StaticResource BorderLightBrush}"
                BorderThickness="0,1,0,0"
                Padding="24,16">
            <Button Content="Close"
                    Command="{Binding CloseCommand}"
                    Style="{StaticResource PrimaryButton}"
                    Height="48"
                    HorizontalAlignment="Right"
                    MinWidth="120"
                    TabIndex="11"
                    IsDefault="True"
                    AutomationProperties.Name="Close Dialog"
                    AutomationProperties.HelpText="Closes the Custom Extraction Rules dialog"/>
        </Border>
    </Grid>
</Window>

