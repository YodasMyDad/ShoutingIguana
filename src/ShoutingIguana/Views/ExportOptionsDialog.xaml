<Window x:Class="ShoutingIguana.Views.ExportOptionsDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Export to Excel"
        Height="700"
        Width="650"
        MinHeight="600"
        MinWidth="550"
        WindowStartupLocation="CenterOwner"
        Background="{StaticResource BackgroundBrush}"
        Foreground="{StaticResource TextPrimaryBrush}"
        UseLayoutRounding="True"
        TextOptions.TextFormattingMode="Display"
        ResizeMode="CanResize">
    
    <Grid Margin="0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0"
                Background="{StaticResource SurfaceBrush}"
                BorderBrush="{StaticResource BorderLightBrush}"
                BorderThickness="0,0,0,1"
                Padding="{StaticResource SpacingL}"
                IsEnabled="{Binding IsExporting, Converter={StaticResource InverseBooleanConverter}}">
            <StackPanel Orientation="Horizontal">
                <Border Background="{StaticResource SuccessBrush}"
                        Width="44" Height="44"
                        CornerRadius="8"
                        Margin="0,0,16,0">
                    <TextBlock Text="{StaticResource Icon.Export}"
                               Style="{StaticResource Icon}"
                               FontSize="22"
                               Foreground="White"/>
                </Border>
                <StackPanel VerticalAlignment="Center">
                    <TextBlock Text="Export to Excel"
                               Style="{StaticResource TitleTextStyle}"
                               Margin="0"
                               AutomationProperties.HeadingLevel="Level1"/>
                    <TextBlock Text="Select plugins and configure export options"
                               Style="{StaticResource BodyTextStyle}"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               Margin="0,4,0,0"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Options -->
        <ScrollViewer Grid.Row="1"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled"
                      Padding="{StaticResource SpacingL}"
                      IsEnabled="{Binding IsExporting, Converter={StaticResource InverseBooleanConverter}}">
            <Border Style="{StaticResource Card}">
                <StackPanel>
                    <!-- Plugin Selection Section -->
                    <StackPanel Margin="0,0,0,24">
                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0"
                                       Text="Select Plugins to Export"
                                       FontWeight="SemiBold"
                                       FontSize="14"
                                       VerticalAlignment="Center"/>
                            
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Button Content="Select All"
                                        Command="{Binding SelectAllPluginsCommand}"
                                        Style="{StaticResource SecondaryButton}"
                                        Height="28"
                                        Padding="12,4"
                                        FontSize="12"
                                        Margin="0,0,8,0"/>
                                <Button Content="Deselect All"
                                        Command="{Binding DeselectAllPluginsCommand}"
                                        Style="{StaticResource SecondaryButton}"
                                        Height="28"
                                        Padding="12,4"
                                        FontSize="12"/>
                            </StackPanel>
                        </Grid>
                        
                        <TextBlock Text="Choose which plugins' findings to include in the export"
                                   Style="{StaticResource HelperText}"
                                   Margin="0,0,0,12"/>
                        
                        <!-- Plugin List with Scrolling -->
                        <Border Background="{StaticResource SurfaceAltBrush}"
                                CornerRadius="6"
                                Padding="12"
                                MaxHeight="200">
                            <ScrollViewer VerticalScrollBarVisibility="Auto"
                                         HorizontalScrollBarVisibility="Disabled">
                                <ItemsControl ItemsSource="{Binding PluginSelectionItems}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <CheckBox IsChecked="{Binding IsSelected}"
                                                      Margin="0,0,0,8"
                                                      FontSize="14">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="{Binding DisplayName}"
                                                               VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding FindingCount, StringFormat=' ({0} findings)'}"
                                                               Foreground="{StaticResource TextSecondaryBrush}"
                                                               VerticalAlignment="Center"
                                                               Margin="4,0,0,0"
                                                               FontSize="12"/>
                                                </StackPanel>
                                            </CheckBox>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Border>
                    </StackPanel>
                    
                    <!-- Severity Filter Section -->
                    <StackPanel Margin="0,0,0,24">
                        <TextBlock Text="Include Severity Levels"
                                   FontWeight="SemiBold"
                                   FontSize="14"
                                   Margin="0,0,0,8"/>
                        <TextBlock Text="Select which severity levels to include in the export"
                                   Style="{StaticResource HelperText}"
                                   Margin="0,0,0,12"/>
                        
                        <CheckBox IsChecked="{Binding IncludeErrors}"
                                  Content="Errors"
                                  FontSize="14"
                                  Margin="0,0,0,8"/>
                        
                        <CheckBox IsChecked="{Binding IncludeWarnings}"
                                  Content="Warnings"
                                  FontSize="14"
                                  Margin="0,0,0,8"/>
                        
                        <CheckBox IsChecked="{Binding IncludeInfo}"
                                  Content="Info"
                                  FontSize="14"
                                  Margin="0,0,0,0"/>
                    </StackPanel>
                    
                    <!-- Technical Metadata Option -->
                    <CheckBox IsChecked="{Binding IncludeTechnicalMetadata}"
                              FontSize="14"
                              Margin="0,0,0,0">
                        <StackPanel>
                            <TextBlock Text="Include Technical Metadata" 
                                       FontWeight="SemiBold"
                                       TextWrapping="Wrap"/>
                            <TextBlock Text="Adds an additional column with raw technical data (JSON format) for advanced analysis"
                                       Style="{StaticResource HelperText}"/>
                        </StackPanel>
                    </CheckBox>
                </StackPanel>
            </Border>
        </ScrollViewer>

        <!-- Action Buttons -->
        <Border Grid.Row="2"
                Background="{StaticResource SurfaceBrush}"
                BorderBrush="{StaticResource BorderLightBrush}"
                BorderThickness="0,1,0,0"
                Padding="{StaticResource SpacingL}"
                IsEnabled="{Binding IsExporting, Converter={StaticResource InverseBooleanConverter}}">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <Button Content="Cancel"
                        Command="{Binding CancelCommand}"
                        Style="{StaticResource SecondaryButton}"
                        MinWidth="100"
                        Height="48"
                        Margin="0,0,12,0"
                        IsCancel="True"
                        AutomationProperties.Name="Cancel Export"
                        AutomationProperties.HelpText="Closes the export dialog without exporting"/>
                <Button Command="{Binding OkAsyncCommand}"
                        Style="{StaticResource PrimaryButton}"
                        MinWidth="140"
                        Height="48"
                        IsDefault="True"
                        AutomationProperties.Name="Export to Excel"
                        AutomationProperties.HelpText="Exports findings to Excel with the selected options">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{StaticResource Icon.Save}"
                                   Style="{StaticResource Icon}"
                                   Width="16"
                                   Height="16"
                                   Margin="0,0,8,0"/>
                        <TextBlock Text="Export to Excel" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Border>
        
        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="3"
              Background="#CC000000"
              Visibility="{Binding IsExporting, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Border Background="{StaticResource SurfaceBrush}"
                    CornerRadius="8"
                    Padding="32"
                    MaxWidth="350"
                    MaxHeight="200"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <!-- Spinning loader -->
                    <Viewbox Width="48" Height="48" Margin="0,0,0,16">
                        <Grid>
                            <Ellipse Width="48" Height="48" 
                                    Stroke="{StaticResource BorderLightBrush}" 
                                    StrokeThickness="4"/>
                            <Ellipse Width="48" Height="48" 
                                    Stroke="{StaticResource PrimaryBrush}" 
                                    StrokeThickness="4"
                                    StrokeDashArray="32 100"
                                    RenderTransformOrigin="0.5,0.5">
                                <Ellipse.RenderTransform>
                                    <RotateTransform x:Name="SpinnerRotation"/>
                                </Ellipse.RenderTransform>
                                <Ellipse.Triggers>
                                    <EventTrigger RoutedEvent="Loaded">
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetName="SpinnerRotation"
                                                               Storyboard.TargetProperty="Angle"
                                                               From="0" To="360"
                                                               Duration="0:0:1"
                                                               RepeatBehavior="Forever"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                </Ellipse.Triggers>
                            </Ellipse>
                        </Grid>
                    </Viewbox>
                    
                    <TextBlock Text="{Binding ExportStatus}"
                               FontSize="16"
                               FontWeight="SemiBold"
                               TextAlignment="Center"
                               Foreground="{StaticResource TextPrimaryBrush}"
                               TextWrapping="Wrap"/>
                    
                    <TextBlock Text="Please wait..."
                               FontSize="14"
                               TextAlignment="Center"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               Margin="0,8,0,0"/>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Window>

